___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "GA4 Measurement Protocol",
  "brand": {
    "id": "brand_dummy",
    "displayName": {
      "text": "Métricas Boss",
      "translations": [
        {
          "locale": "br",
          "text": "Métricas Boss"
        }
      ]
    },
    "thumbnail": "data:image/jpeg;base64,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"
  },
  "description": {
    "text": "Send events directly to Google Analytics 4 via Measurement Protocol. Optimized for webhooks and server-side tracking.",
    "translations": [
      {
        "locale": "br",
        "text": "Envie eventos diretamente para o Google Analytics 4 via Measurement Protocol. Otimizado para webhooks e rastreamento server-side."
      }
    ]
  },
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "CHECKBOX",
    "name": "enableDebug",
    "checkboxText": {
      "text": "Enable Debug Logs",
      "translations": [
        {
          "locale": "br",
          "text": "Ativar Logs de Debug"
        }
      ]
    },
    "simpleValueType": true,
    "defaultValue": false,
    "help": {
      "text": "Enable detailed debug logging",
      "translations": [
        {
          "locale": "br",
          "text": "Ativar logs detalhados de debug"
        }
      ]
    }
  },
  {
    "type": "TEXT",
    "name": "measurementId",
    "displayName": {
      "text": "Measurement ID",
      "translations": [
        {
          "locale": "br",
          "text": "ID de Medição"
        }
      ]
    },
    "simpleValueType": true,
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "REGEX",
        "args": [
          "^G-[A-Z0-9]+"
        ]
      }
    ],
    "valueHint": "G-XXXXXXXXX",
    "help": {
      "text": "Google Analytics 4 Measurement ID (format: G-XXXXXXXXX)",
      "translations": [
        {
          "locale": "br",
          "text": "ID de Medição do Google Analytics 4 (formato: G-XXXXXXXXX)"
        }
      ]
    }
  },
  {
    "type": "TEXT",
    "name": "apiSecret",
    "displayName": {
      "text": "API Secret",
      "translations": [
        {
          "locale": "br",
          "text": "Chave Secreta da API"
        }
      ]
    },
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": {
      "text": "Create an API secret in your GA4 property (Admin > Data Streams > Measurement Protocol API secrets)",
      "translations": [
        {
          "locale": "br",
          "text": "Crie uma chave secreta na sua propriedade GA4 (Admin > Fluxos de Dados > Segredos de API do Measurement Protocol)"
        }
      ]
    }
  },
  {
    "type": "CHECKBOX",
    "name": "useDebugEndpoint",
    "checkboxText": {
      "text": "Use Debug Endpoint",
      "translations": [
        {
          "locale": "br",
          "text": "Usar Endpoint de Debug"
        }
      ]
    },
    "simpleValueType": true,
    "defaultValue": false,
    "help": {
      "text": "Send events to GA4 debug endpoint for validation (events won't be recorded in reports)",
      "translations": [
        {
          "locale": "br",
          "text": "Enviar eventos para endpoint de debug do GA4 para validação (eventos não serão gravados nos relatórios)"
        }
      ]
    }
  },
  {
    "type": "GROUP",
    "name": "grpIdentifiers",
    "displayName": {
      "text": "Client & User Identifiers",
      "translations": [
        {
          "locale": "br",
          "text": "Identificadores de Cliente e Usuário"
        }
      ]
    },
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "clientIdField",
        "displayName": {
          "text": "Client ID Field Name",
          "translations": [
            {
              "locale": "br",
              "text": "Nome do Campo Client ID"
            }
          ]
        },
        "simpleValueType": true,
        "defaultValue": "client_id",
        "help": {
          "text": "Event field name containing the client_id. Default: 'client_id'",
          "translations": [
            {
              "locale": "br",
              "text": "Nome do campo do evento que contém o client_id. Padrão: 'client_id'"
            }
          ]
        }
      },
      {
        "type": "TEXT",
        "name": "clientIdOverride",
        "displayName": {
          "text": "Manual Client ID (Optional)",
          "translations": [
            {
              "locale": "br",
              "text": "Client ID Manual (Opcional)"
            }
          ]
        },
        "simpleValueType": true,
        "help": {
          "text": "Manually set client_id (overrides automatic detection)",
          "translations": [
            {
              "locale": "br",
              "text": "Definir client_id manualmente (sobrescreve detecção automática)"
            }
          ]
        }
      },
      {
        "type": "TEXT",
        "name": "userIdField",
        "displayName": {
          "text": "User ID Field Name (Optional)",
          "translations": [
            {
              "locale": "br",
              "text": "Nome do Campo User ID (Opcional)"
            }
          ]
        },
        "simpleValueType": true,
        "defaultValue": "user_id",
        "help": {
          "text": "Event field name containing the user_id",
          "translations": [
            {
              "locale": "br",
              "text": "Nome do campo do evento que contém o user_id"
            }
          ]
        }
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "grpEvent",
    "displayName": {
      "text": "Event Configuration",
      "translations": [
        {
          "locale": "br",
          "text": "Configuração do Evento"
        }
      ]
    },
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "eventNameField",
        "displayName": {
          "text": "Event Name Field",
          "translations": [
            {
              "locale": "br",
              "text": "Campo do Nome do Evento"
            }
          ]
        },
        "simpleValueType": true,
        "defaultValue": "event_name",
        "help": {
          "text": "Event field containing the event name. Default: 'event_name'",
          "translations": [
            {
              "locale": "br",
              "text": "Campo do evento que contém o nome do evento. Padrão: 'event_name'"
            }
          ]
        }
      },
      {
        "type": "TEXT",
        "name": "eventNameOverride",
        "displayName": {
          "text": "Manual Event Name (Optional)",
          "translations": [
            {
              "locale": "br",
              "text": "Nome do Evento Manual (Opcional)"
            }
          ]
        },
        "simpleValueType": true,
        "help": {
          "text": "Manually set event name (overrides automatic detection)",
          "translations": [
            {
              "locale": "br",
              "text": "Definir nome do evento manualmente (sobrescreve detecção automática)"
            }
          ]
        }
      },
      {
        "type": "TEXT",
        "name": "sessionIdField",
        "displayName": {
          "text": "Session ID Field Name",
          "translations": [
            {
              "locale": "br",
              "text": "Nome do Campo Session ID"
            }
          ]
        },
        "simpleValueType": true,
        "defaultValue": "session_id",
        "help": {
          "text": "Event field name containing the session_id",
          "translations": [
            {
              "locale": "br",
              "text": "Nome do campo que contém o session_id"
            }
          ]
        }
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "grpEventParams",
    "displayName": {
      "text": "Event Parameters",
      "translations": [
        {
          "locale": "br",
          "text": "Parâmetros do Evento"
        }
      ]
    },
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "forwardAllParams",
        "checkboxText": {
          "text": "Forward All Event Parameters",
          "translations": [
            {
              "locale": "br",
              "text": "Encaminhar Todos os Parâmetros do Evento"
            }
          ]
        },
        "simpleValueType": true,
        "defaultValue": true,
        "help": {
          "text": "Automatically forward all event parameters to GA4",
          "translations": [
            {
              "locale": "br",
              "text": "Encaminhar automaticamente todos os parâmetros do evento para GA4"
            }
          ]
        }
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "skipParams",
        "displayName": {
          "text": "Parameters to Skip",
          "translations": [
            {
              "locale": "br",
              "text": "Parâmetros para Ignorar"
            }
          ]
        },
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": {
              "text": "Parameter Name",
              "translations": [
                {
                  "locale": "br",
                  "text": "Nome do Parâmetro"
                }
              ]
            },
            "name": "paramName",
            "type": "TEXT"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "forwardAllParams",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "customParams",
        "displayName": {
          "text": "Custom Parameters to Add",
          "translations": [
            {
              "locale": "br",
              "text": "Parâmetros Personalizados para Adicionar"
            }
          ]
        },
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": {
              "text": "Name",
              "translations": [
                {
                  "locale": "br",
                  "text": "Nome"
                }
              ]
            },
            "name": "name",
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": {
              "text": "Value",
              "translations": [
                {
                  "locale": "br",
                  "text": "Valor"
                }
              ]
            },
            "name": "value",
            "type": "TEXT"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "grpUserProps",
    "displayName": {
      "text": "User Properties",
      "translations": [
        {
          "locale": "br",
          "text": "Propriedades do Usuário"
        }
      ]
    },
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "userProperties",
        "displayName": {
          "text": "User Properties",
          "translations": [
            {
              "locale": "br",
              "text": "Propriedades do Usuário"
            }
          ]
        },
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": {
              "text": "Name",
              "translations": [
                {
                  "locale": "br",
                  "text": "Nome"
                }
              ]
            },
            "name": "name",
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": {
              "text": "Value",
              "translations": [
                {
                  "locale": "br",
                  "text": "Valor"
                }
              ]
            },
            "name": "value",
            "type": "TEXT"
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const sendHttpRequest = require('sendHttpRequest');
const getAllEventData = require('getAllEventData');
const getTimestampMillis = require('getTimestampMillis');
const logToConsole = require('logToConsole');
const JSON = require('JSON');
const Object = require('Object');

// Debug logging
function log(message, obj) {
  if (data.enableDebug) {
    if (obj) {
      logToConsole('[GA4 MP]', message, obj);
    } else {
      logToConsole('[GA4 MP]', message);
    }
  }
}

/**
 * Recursively searches for a field in a nested object structure
 * @param {Object} obj - The object to search in
 * @param {string} fieldName - The field name to search for
 * @param {number} depth - Current recursion depth (for safety)
 * @returns {*} The field value if found, null otherwise
 */
function findFieldRecursive(obj, fieldName, depth) {
  depth = depth || 0;

  // Safety limit to prevent infinite recursion
  if (depth > 10) {
    return null;
  }

  // Check if obj is valid
  if (!obj || typeof obj !== 'object') {
    return null;
  }

  // Check at current level
  if (obj[fieldName] !== undefined && obj[fieldName] !== null) {
    return obj[fieldName];
  }

  // Recursively search in nested objects
  for (const key in obj) {
    const value = obj[key];

    // Skip arrays and non-objects
    if (value && typeof value === 'object' && typeof value.push !== 'function') {
      const found = findFieldRecursive(value, fieldName, depth + 1);
      if (found !== null) {
        return found;
      }
    }
  }

  return null;
}

// Get all event data
const eventData = getAllEventData();
log('Received event data:', eventData);

// Build GA4 Measurement Protocol URL
const baseUrl = data.useDebugEndpoint
  ? 'https://www.google-analytics.com/debug/mp/collect'
  : 'https://www.google-analytics.com/mp/collect';

const url = baseUrl + '?measurement_id=' + data.measurementId + '&api_secret=' + data.apiSecret;
log('GA4 MP URL:', url);

// Extract client_id with recursive search
const clientIdFieldName = data.clientIdField || 'client_id';
let clientId = data.clientIdOverride || eventData[clientIdFieldName] || findFieldRecursive(eventData, clientIdFieldName);
if (!clientId) {
  log('ERROR: client_id not found in event data');
  return data.gtmOnFailure();
}
log('Client ID found:', clientId);

// Extract user_id (optional) with recursive search
const userIdFieldName = data.userIdField || 'user_id';
const userId = eventData[userIdFieldName] || findFieldRecursive(eventData, userIdFieldName);
if (userId) {
  log('User ID found:', userId);
}

// Extract event name with recursive search
const eventNameFieldName = data.eventNameField || 'event_name';
const eventName = data.eventNameOverride || eventData[eventNameFieldName] || findFieldRecursive(eventData, eventNameFieldName);
if (!eventName) {
  log('ERROR: event_name not found in event data');
  return data.gtmOnFailure();
}
log('Event Name found:', eventName);

// Extract session_id with recursive search
const sessionIdFieldName = data.sessionIdField || 'session_id';
const sessionId = eventData[sessionIdFieldName] || findFieldRecursive(eventData, sessionIdFieldName);
if (sessionId) {
  log('Session ID found:', sessionId);
}

// Build event parameters
const eventParams = {};

// Default fields to skip (internal GTM fields and webhook metadata)
const defaultSkipFields = [
  'event_name',
  'client_id',
  'user_id',
  'session_id',
  'ip_override',
  'user_agent',
  'page_location',
  'page_title',
  // Webhook metadata fields
  'webhook_data',
  'webhook_path',
  'webhook_timestamp',
  'webhook_id',
  'webhook_headers',
  'x-gtm-server-preview'
];

// Add session_id to params if present
if (sessionId) {
  eventParams.session_id = sessionId;
}

// Forward all event parameters
if (data.forwardAllParams) {
  // Build skip list
  const skipList = defaultSkipFields.slice();
  if (data.skipParams) {
    data.skipParams.forEach(function(item) {
      if (item.paramName) {
        skipList.push(item.paramName);
      }
    });
  }

  log('Skip list:', skipList);

  // Copy event parameters (only primitive values and items array)
  for (const key in eventData) {
    if (skipList.indexOf(key) === -1) {
      const value = eventData[key];
      const valueType = typeof value;

      // Only forward primitive values (string, number, boolean)
      // or the special 'items' array for e-commerce
      if (valueType === 'string' || valueType === 'number' || valueType === 'boolean') {
        eventParams[key] = value;
      } else if (key === 'items' && value && typeof value.push === 'function') {
        // Special handling for items array
        eventParams[key] = value;
      }
      // Skip objects and other arrays (they would become [object Object])
    }
  }
}

// Add custom parameters
if (data.customParams) {
  data.customParams.forEach(function(param) {
    if (param.name && param.value !== undefined) {
      eventParams[param.name] = param.value;
    }
  });
}

log('Event parameters:', eventParams);

// Clean null values from items array
if (eventParams.items && typeof eventParams.items.push === 'function') {
  const cleanedItems = [];

  for (let i = 0; i < eventParams.items.length; i++) {
    const item = eventParams.items[i];
    const cleanedItem = {};

    for (const key in item) {
      const value = item[key];
      if (value !== null && value !== undefined && value !== '') {
        cleanedItem[key] = value;
      }
    }

    if (Object.keys(cleanedItem).length > 0) {
      cleanedItems.push(cleanedItem);
    }
  }

  eventParams.items = cleanedItems;
  log('Cleaned items:', cleanedItems.length + ' items');
}

// Build payload
const payload = {
  client_id: clientId,
  timestamp_micros: getTimestampMillis() * 1000,
  non_personalized_ads: false,
  events: [{
    name: eventName,
    params: eventParams
  }]
};

// Add user_id if present
if (userId) {
  payload.user_id = userId;
}

// Add user properties
if (data.userProperties && data.userProperties.length > 0) {
  payload.user_properties = {};
  data.userProperties.forEach(function(prop) {
    if (prop.name && prop.value !== undefined) {
      payload.user_properties[prop.name] = {value: prop.value};
    }
  });
  log('User properties:', payload.user_properties);
}

log('Final payload:', payload);

// Send request to GA4
sendHttpRequest(
  url,
  {
    headers: {
      'Content-Type': 'application/json'
    },
    method: 'POST',
    timeout: 5000
  },
  JSON.stringify(payload)
).then(function(result) {
  log('GA4 response:', {
    statusCode: result.statusCode,
    body: result.body
  });

  if (result.statusCode >= 200 && result.statusCode < 300) {
    log('Event sent successfully to GA4');
    data.gtmOnSuccess();
  } else {
    log('GA4 returned error status:', result.statusCode);
    data.gtmOnFailure();
  }
}).catch(function(error) {
  log('HTTP request failed:', error);
  data.gtmOnFailure();
});


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://www.google-analytics.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created by Métricas Boss
Optimized for webhook integration and server-side tracking
Documentation: https://metricasboss.com.br
