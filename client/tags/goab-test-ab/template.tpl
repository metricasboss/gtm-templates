___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "goab_test_ab",
  "version": 1,
  "securityGroups": [],
  "displayName": "GoAB Test A/B",
  "description": {
    "text": "Powered By Métricas Boss: Implements GoAB A/B testing platform with automatic anti-flicker and user identification management.",
    "translations": [
      {
        "locale": "pt-BR",
        "text": "Powered By Métricas Boss: Implementa a plataforma brasileira de testes A/B GoAB com anti-flicker automático e gerenciamento de identificação de usuários."
      }
    ]
  },
  "categories": ["CONVERSIONS", "MARKETING"],
  "brand": {
    "id": "brand_dummy",
    "displayName": "Métricas Boss",
    "thumbnail": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAMCAgMCAgMDAwMEAwMEBQgFBQQEBQoHBwYIDAoMDAsKCwsNDhIQDQ4RDgsLEBYQERMUFRUVDA8XGBYUGBIUFRT/2wBDAQMEBAUEBQkFBQkUDQsNFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBT/wgARCADIAMgDASIAAhEBAxEB/8QAHAABAAIDAAMAAAAAAAAAAAAAAAcIAQMGAgQF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAABqoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB5eNoSC9lxPjFVFqxU7lb9QkVxAAAAAAAASp3xXCy+jJEHG2SFbVkRGEj7xWxZIVtdhx4AAAAAzjzLb/AGPlRYdirILOK3TCdgrJgs2rNZkTLTKx5E0LTTCwAAAAA36PYLcxRLETkK9tJfRnVqe+qWqjThbbHxYK5L3jj7hVis6RNC00wsAAAAAN+jcW7iiVYqId0dbZsja0tQItO0jex1kCosr8RXs962lPbhETQtNMLAAAAADZr8y3XHbJkIajS2AqAt+KgdHZ7JTxcLBT60f3RXSFpPjAAAAAAZwPLGAABs2+sNuvAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//EACkQAAAFAwMDBAMBAAAAAAAAAAAEBQYHAgMXATA2FjE1EBETMiFAcCD/2gAIAQEAAQUC/j9NOtWtDSW7lPRy4OjlwdHLgutRas0dv04cQ7Fy2ryIjIh/LKAMsoAyygBDfyQ4D0wodgoa/SjN3JSEhu89YU3L6sJTLI7olB0Ja+Q32gwrrtK4WMjCxkYXMjC5oYXMjC5kYXMjCxoYWMjCxkYVMh0t2trqm5DHiHfJFTWV82VjNlYzXWM13Bmu4M13BmusZsrGbKwynVq7U6W+W7dPeGvwky5y30KFbp4yqRSqpiX6U0611M+MqLNt31pt1wQzx6W+W7dn7Q94qXOWhttBRc94qkt6NCt+X0WiwusZNeBO1FC9dJo7aSI6IO9+HXTcEM8elvlu3Z+0PeKlzlrBY6aqJ7jlOwQtHDt9QMa066aN9yHm0csyqhVpy6umnCoNtrHnQbcSHebitDPHpb5bt2ftDvipc5boYu02O4ZcZGjt9VSSiomOxjHmtdDLjoy49XG+U5nFDp6+omYZ49LfLdu19oc8VLnLW+1lBy3yLeb8clXVJh9dF1TOX7LQkzT4i6ClUEHvJV05V6Qzx6W+W7dHeG/Eya3VNUcyApOtvIJ9uOZTM9Fro6MXR0YuihPeNsh0WujoxdHRi6IqSzaSiS3y3bp7xk6ktATslNwZKbYyU2xkptjJTbGSW4Mjt0ZIbgyU3BkptjJTbEirBRccW3p+B7/60q9h8w1r9/5D/8QAFBEBAAAAAAAAAAAAAAAAAAAAcP/aAAgBAwEBPwEp/8QAFBEBAAAAAAAAAAAAAAAAAAAAcP/aAAgBAgEBPwEp/8QARRAAAQIDAwQNCAkEAwAAAAAAAQIDAAQREzGTBRMh0RQyMDYzQFBUY3SyweIGI0Jic3SRsgcRI2CBcZSx0qGiJDPD8P/aAAgBAQAGPwL/AAiGF5JnGwsgjxpvhteSTQe+6nEZpqWYbYSAtYoKGCL+TOIPPuddpXCms0f/AJBhqVyQ4mbeG0bOLK5/jSsSS82h1BUo1USaClOCEts+UclNpn5JWaVwV0oe5hLMyQ2rOMqJQo8k6DFBpMXlrK3HUE3VOJjlr1YoMqZKJCkKKlXFAqp4K8eoQJjKslMOy+TC7LiADQ8hoW6Bky/YaSDVpI/qMO+T07NIS7LAW6FTVO5htyUczTjYtNLXSjlfwz0HDXQ/lhWQHXUSiWxdCk5wVr86FYTkaadaCJZJCr6L22r1vKwXHZppDTSd8oFN+OWDf8+G/wDiMZLynLLeEkl2PpX/AM+PHf8A1r1Iy4qQdTlJU3Gkh5V5WuBXBh2UVwJtlq/qRpEPyVl1tZSshFKpI5Y6g+oK4SaHgX4HQY+s8lyOUJbWpC7xxH4gxLSy5ptyT+kyE14pxvCOXhT3u/VnmMn5VZflCL1WySDh1+eM9Muok5UGl6l5axx8sZMdlH8jOqZm23b5QRQ0JisJlM+6hqWb+0ukDSdUYXkqczCJglN5KKKQU0OjTBVkmWV5MULTak31FV6gpyRMy6pZSUsrOaUhV4EaOUYc8jcU/J7jtm3uqFGhxQcmXjMyq0kqvNrO+nBj+sX8qMJdloIKlqU3xkA0J7gv/X/8w9/p8q5PkiXgKBCLy1DVTRvxt0P5YmMpq+pcFGm0jQkaODZH8YdmfqyVmUObK7iU3r144hRr3N/vFB/E69LKl3+pdUpNDTurpindiieysZdTL6VJSCcGhB1fqW8qs/SXkvbZ5K3VSJjbJ/8A9TP1h2bmnpiWeQptOa4FwkHgKP4jGJSC3dJWBTGYym3KvKz6FpVdXxEU83gqR/EYc8kMqIRKuKszCSL44K+2BfgdBjBD/j/nF4xgYITQQgJ+7FI/ipP/xAArEAEAAgECBAUEAwEBAAAAAAABABEhMUFRYYGhEHGRsdEgMMHwQOHxcPD/2gAIAQEAAT8h/wCnwVSCWCWCWgw1INhSNSLlvSLlvSNSH6YP0w+oepB/qv5p+aftI/a/KV/dP5p+7P5p+9Hwym/i+h+qLx+mHlmLH5ifuv8Aqn7qf1T9mf1S5T+qn+SH6o0odBU3J3Sxly3poP0xLBLBLBqalMp5TQpGpDlKxl1v+ZUsqopoAW/xKAn65oCzS5M9pQ3M+KIy6j7w20YZV8hfgVoVheCcCvWVTBCzxrOZCrHdgfaOVDpdv8Spe5LxZm6qYfxm5LxnHaU+zWWz7mUSQ2YzNqrR+bPqrfmEqhWvXH3hOXw16o0FjQK59oxZV6RlBG9LxfSBFagPl+LyhKQY/L/5EVAzrpAXvWXiBQmMJPzf3h1Ul3/iUsW1nHiUsUOsKQs5/cXoCPgw0D98RbZXl+JTpYpYrXKaBWgAo7FfBaolNoBZdQ0DU/ooKtx/BV4waxGQAW+r4hqW8IU5c3zKGHBqE4Bju0JQuwMvvCqVsvT8SkGudYXt90lGq1feEM+TsShH+qBWlVWWrPMIGhwXN94CrgpvVPWJ2xC/QQaoPr/5ChC96cU8Shu1nKABPZg3oamE+AcYz0g5vTlKTnHX7lBQb0vqesqGFZq/M2SZiJCIx9QqAa7c+JfaALlnc+8rYl0/mFwCp/8AMBsq02giN7rQhsFaL8ylmx9RYW3dT0I8PwamEp6MoJZaP3Ly0ePzLqtpW+8JYLgZ4S6i0YuMZdBjE8RFAaV8Ri2aTTWlgFBJDEv0/wD5gMqjU//aAAwDAQACAAMAAAAQ8888888888888888888888888888888888888888888888888888848AQg88888888oowAAw88888884wg88s888888sAcs8888888888oEog888888888ooss888888888888888888888888888888888888888888888//xAAUEQEAAAAAAAAAAAAAAAAAAABw/9oACAEDAQE/ECn/xAAUEQEAAAAAAAAAAAAAAAAAAABw/9oACAECAQE/ECn/xAArEAEAAgECBAYCAgMBAAAAAAABABEhMUFRYXGBEJGhscHwINEw4fFA8UD/2gAIAQEAAT8Q/wCnwuRaDCn8zMMEaWfnJ5Zn8FnpEV3ZP3v6Q/2RxWVN8vfOHPO0ZDxeV82dmgxmxB1KG4yHj0v4Xc3imFRt/l4gZdHGn+fvNnYMqAR7Q+O1vf2lu0fDd37Qi4pX98Jt3Pm9vc+F+gKAtgWw7e+XWMAB0y7HPSLZ7PF+LDyWcsPXOnGFQAHQ5+V9MZ5gLXv6fwhoDqLj1DfPT0mWcRyJzw5TVTbVDdoP8WpkFtPr+v4ybAu6v7OMqCwtQF5+J5p45WKpgkxFxjO36w3yQKO5+Zh0G/S4xDKAbVG//tAWOVEVR/7pqDQuWXwzL2Ff3KGvMa6jtAtqaWAFT4SsITEZn39H7j3FLVVenPSECgXRHbxjOLQOrMBP/IGAGFZxMx8b/p8IHnCZ/P2ltBRWYiobPe0d7QKr97R1SgHnXQvFPDNSlq9u3rLNZFR8Rf1gW6oVHu/TwhXe6ABTlbjXWUgFg/7E7wMc4m+rfUU0jWGg/mEGBBOuoB/q6PaGAAJ93Aj3VwTvNx38gkVc19oFhLoDxwvDC/f6l6Oo38yroLd1z18IeIAIDzqg/cWWg78XARdwdDljnqZipcm1PVcyysq8l2FzqZqoprz/AFBgCqKssBXP++cL6jj1z1j1b2XmOj+sPdcGPWvxLQzUQxOufeZK+NB0XeHALTiYe8NgSGJXF1nw1z+/jDzWL65T+8LGmPn8TNcKLPe8Y+OB/f8AP5gYAuK38qv8wGAAKf8A/9k="
  },
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "configGroup",
    "displayName": {
      "text": "GoAB Configuration",
      "translations": [
        {
          "locale": "pt-BR",
          "text": "Configuração do GoAB"
        }
      ]
    },
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "accountId",
        "displayName": {
          "text": "Account ID",
          "translations": [
            {
              "locale": "pt-BR",
              "text": "ID da Conta"
            }
          ]
        },
        "simpleValueType": true,
        "valueValidators": [{ "type": "NON_EMPTY" }],
        "help": {
          "text": "Your GoAB account ID (found in GoAB dashboard)",
          "translations": [
            {
              "locale": "pt-BR",
              "text": "Seu ID de conta GoAB (encontrado no painel GoAB)"
            }
          ]
        }
      },
      {
        "type": "TEXT",
        "name": "timeout",
        "displayName": {
          "text": "Anti-Flicker Timeout (ms)",
          "translations": [
            {
              "locale": "pt-BR",
              "text": "Timeout Anti-Flicker (ms)"
            }
          ]
        },
        "simpleValueType": true,
        "defaultValue": "1000",
        "valueValidators": [{ "type": "POSITIVE_NUMBER" }],
        "help": {
          "text": "Maximum time in milliseconds to hide page while loading test (recommended: 1000-2000ms)",
          "translations": [
            {
              "locale": "pt-BR",
              "text": "Tempo máximo em milissegundos para esconder página enquanto carrega teste (recomendado: 1000-2000ms)"
            }
          ]
        }
      },
      {
        "type": "TEXT",
        "name": "scriptVersion",
        "displayName": {
          "text": "Script Version",
          "translations": [
            {
              "locale": "pt-BR",
              "text": "Versão do Script"
            }
          ]
        },
        "simpleValueType": true,
        "defaultValue": "2.0.0",
        "help": {
          "text": "GoAB script version (leave default unless instructed otherwise)",
          "translations": [
            {
              "locale": "pt-BR",
              "text": "Versão do script GoAB (deixe padrão a menos que instruído de outra forma)"
            }
          ]
        }
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "enableDebug",
    "checkboxText": {
      "text": "Enable debug logs in console",
      "translations": [
        {
          "locale": "pt-BR",
          "text": "Habilitar logs de debug no console"
        }
      ]
    },
    "simpleValueType": true,
    "defaultValue": false
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// ========================================
// IMPORTAÇÃO DE APIs GTM
// ========================================
const setInWindow = require('setInWindow');
const copyFromWindow = require('copyFromWindow');
const injectScript = require('injectScript');
const log = require('logToConsole');
const getUrl = require('getUrl');
const makeNumber = require('makeNumber');
const encodeUriComponent = require('encodeUriComponent');

// ========================================
// FUNÇÃO DE DEBUG
// ========================================
function debugLog(msg, obj) {
  if (data.enableDebug) {
    log('[GoAB]', msg, obj !== undefined ? obj : '');
  }
}

debugLog('Iniciando template GoAB...');

// ========================================
// VALIDAÇÃO DE CONFIGURAÇÃO
// ========================================

// Verificar accountId
if (!data.accountId || data.accountId.trim() === '') {
  debugLog('Erro: accountId é obrigatório');
  return data.gtmOnFailure();
}

// Fixar accountType como 'devs' (prod.goab.io não existe)
const accountType = 'devs';

// Validar timeout
let timeout = 3000; // padrão (aumentado para dar tempo do script carregar)
if (data.timeout !== undefined && data.timeout !== '') {
  timeout = makeNumber(data.timeout);
  if (!timeout || timeout < 0 || timeout > 10000) {
    debugLog('Timeout inválido, usando padrão (1000ms)');
    timeout = 1000;
  }
}

// Versão do script
const scriptVersion = data.scriptVersion || '2.0.0';

debugLog('Configuração:', {
  accountId: data.accountId,
  accountType: accountType,
  timeout: timeout,
  version: scriptVersion
});

// ========================================
// VERIFICAR SE JÁ FOI INICIALIZADO
// ========================================
const existingGoabCode = copyFromWindow('goab_code');
if (existingGoabCode) {
  debugLog('GoAB já inicializado, ignorando...');
  return data.gtmOnSuccess();
}

// ========================================
// VERIFICAR DISABLE FLAG
// ========================================
const currentUrl = getUrl('search');
if (currentUrl && currentUrl.indexOf('__goab_disable') !== -1) {
  debugLog('Desabilitado via URL flag (__goab_disable)');
  return data.gtmOnSuccess();
}

// ========================================
// PREPARAR CONFIGURAÇÃO PARA O SCRIPT
// ========================================

// Criar objeto de configuração
const goabConfig = {
  accountId: data.accountId,
  timeout: timeout,
  version: scriptVersion,
  accountType: accountType,
  debug: data.enableDebug
};

// Setar configuração no window
setInWindow('__goabConfig', goabConfig, true);

debugLog('Configuração setada no window.__goabConfig');

// ========================================
// INJETAR SCRIPT DE INICIALIZAÇÃO DO S3
// ========================================

const scriptUrl = 'https://gtm-templates.s3.us-east-1.amazonaws.com/goab-init-bundle.js';

injectScript(
  scriptUrl,
  function() {
    debugLog('Script GoAB injetado com sucesso');
    data.gtmOnSuccess();
  },
  function() {
    debugLog('Erro ao injetar script GoAB');
    data.gtmOnFailure();
  },
  'goabInit'
);


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": { "type": 1, "string": "debug" }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  { "type": 1, "string": "key" },
                  { "type": 1, "string": "read" },
                  { "type": 1, "string": "write" },
                  { "type": 1, "string": "execute" }
                ],
                "mapValue": [
                  { "type": 1, "string": "goab_code" },
                  { "type": 8, "boolean": true },
                  { "type": 8, "boolean": true },
                  { "type": 8, "boolean": false }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  { "type": 1, "string": "key" },
                  { "type": 1, "string": "read" },
                  { "type": 1, "string": "write" },
                  { "type": 1, "string": "execute" }
                ],
                "mapValue": [
                  { "type": 1, "string": "goab" },
                  { "type": 8, "boolean": true },
                  { "type": 8, "boolean": true },
                  { "type": 8, "boolean": false }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  { "type": 1, "string": "key" },
                  { "type": 1, "string": "read" },
                  { "type": 1, "string": "write" },
                  { "type": 1, "string": "execute" }
                ],
                "mapValue": [
                  { "type": 1, "string": "__goabConfig" },
                  { "type": 8, "boolean": false },
                  { "type": 8, "boolean": true },
                  { "type": 8, "boolean": false }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              { "type": 1, "string": "https://devs.goab.io/*" },
              { "type": 1, "string": "https://prod.goab.io/*" },
              { "type": 1, "string": "https://gtm-templates.s3.us-east-1.amazonaws.com/*" }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": { "type": 1, "string": "any" }
        },
        {
          "key": "queriesAllowed",
          "value": { "type": 1, "string": "any" }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

## GoAB Test A/B Template

### Features:
- Automatic anti-flicker implementation
- User identification via cookies
- Development and production environments
- Configurable timeout
- URL disable flag (?__goab_disable)
- LocalStorage settings override support

### Configuration:
1. Get your Account ID from GoAB dashboard
2. Choose account type (devs for testing, prod for production)
3. Set timeout (default: 1000ms, recommended: 1000-2000ms)
4. Enable debug for troubleshooting

### How it works:
1. Injects CSS to hide body (anti-flicker)
2. Loads GoAB script from CDN
3. Removes CSS when script loads or timeout expires
4. Manages user identification via cookies

### Disable for QA:
Add ?__goab_disable to URL to prevent GoAB from loading

Created on 2/4/2026
