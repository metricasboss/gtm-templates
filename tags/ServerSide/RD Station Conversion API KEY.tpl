___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "RD Station Conversion API KEY",
  "brand": {
    "id": "brand_dummy",
    "displayName": {
      "text": "Métricas Boss",
      "translations": [
        {
          "locale": "br",
          "text": "Métricas Boss"
        }
      ]
    },
    "thumbnail": "data:image/jpeg;base64,/9j/4QAWRXhpZgAATU0AKgAAAAgAAAAAAAD/2wBDAAMCAgMCAgMDAwMEAwMEBQgFBQQEBQoHBwYIDAoMDAsKCwsNDhIQDQ4RDgsLEBYQERMUFRUVDA8XGBYUGBIUFRT/2wBDAQMEBAUEBQkFBQkUDQsNFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBT/wgARCADIAMgDASIAAhEBAxEB/8QAHAABAAIDAAMAAAAAAAAAAAAAAAcIAQMGAgQF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAABqoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB5eNoSC9lxPjFVFqxU7lb9QkVxAAAAAAAASp3xXCy+jJEHG2SFbVkRGEj7xWxZIVtdhx4AAAAAzjzLb/AGPlRYdirILOK3TCdgrJgs2rNZkTLTKx5E0LTTCwAAAAA36PYLcxRLETkK9tJfRnVqe+qWqjThbbHxYK5L3jj7hVis6RNC00wsAAAAAN+jcW7iiVYqId0dbZsja0tQItO0jex1kCosr8RXs962lPbhETQtNMLAAAAADZr8y3XHbJkIajS2AqAt+KgdHZ7JTxcLBT60f3RXSFpPjAAAAAAZwPLGAABs2+sNuvAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//EACkQAAAFAwMDBAMBAAAAAAAAAAAEBQYHAgMXATA2FjE1EBETMiFAcCD/2gAIAQEAAQUC/j9NOtWtDSW7lPRy4OjlwdHLgutRas0dv04cQ7Fy2ryIjIh/LKAMsoAyygBDfyQ4D0wodgoa/SjN3JSEhu89YU3L6sJTLI7olB0Ja+Q32gwrrtK4WMjCxkYXMjC5oYXMjC5kYXMjCxoYWMjCxkYVMh0t2trqm5DHiHfJFTWV82VjNlYzXWM13Bmu4M13BmusZsrGbKwynVq7U6W+W7dPeGvwky5y30KFbp4yqRSqpiX6U0611M+MqLNt31pt1wQzx6W+W7dn7Q94qXOWhttBRc94qkt6NCt+X0WiwusZNeBO1FC9dJo7aSI6IO9+HXTcEM8elvlu3Z+0PeKlzlrBY6aqJ7jlOwQtHDt9QMa066aN9yHm0csyqhVpy6umnCoNtrHnQbcSHebitDPHpb5bt2ftDvipc5boYu02O4ZcZGjt9VSSiomOxjHmtdDLjoy49XG+U5nFDp6+omYZ49LfLdu19oc8VLnLW+1lBy3yLeb8clXVJh9dF1TOX7LQkzT4i6ClUEHvJV05V6Qzx6W+W7dHeG/Eya3VNUcyApOtvIJ9uOZTM9Fro6MXR0YuihPeNsh0WujoxdHRi6IqSzaSiS3y3bp7xk6ktATslNwZKbYyU2xkptjJTbGSW4Mjt0ZIbgyU3BkptjJTbEirBRccW3p+B7/60q9h8w1r9/5D/8QAFBEBAAAAAAAAAAAAAAAAAAAAcP/aAAgBAwEBPwEp/8QAFBEBAAAAAAAAAAAAAAAAAAAAcP/aAAgBAgEBPwEp/8QARRAAAQIDAwQNCAkEAwAAAAAAAQIDAAQREjWTBRMh0RQiMDEyQVFhc5SyweIQQEJScXSBgwYVI2JwcqGjsSAkM1NjwvD/2gAIAQEABj8C/B8ACpPEICk5JnCD/wAKoumcwTF0zmCYumcwTBUvJU4EjjzKvNJrKjqAt1C8y1X0dFSf1hyTmHHS83ws23UCOFMYUcKYwo4UxhQJSVccz6gSkOIpWJTKLKA2qYqh2nGRvHzN+Xn5sMOGYKwmwo6LKeQc0T81LLzjDi6pVSldH9ErNTbuZYQF1XQn0TyRJNyE0JhbbhUoBKhTRzjzB99ubRLhpdiik1roi82sIxebWEYvNrCMXm1hmLzawzF5tYZi82sMxebWEYvNrCOuLzawjF5tYRjYS3g+bAXaSKb+65Q6cdmNhCQEz9mF287Z3/hF0J6x4YuhPWPDF0J6x4YuhPWPDF0J6x4YuhPWPDF0J6x4YuhPWPDF0J6x4YemTLCWzbubshdqugHk54PQI791n+nHZj5CO/ytS7CM486oISkcZhc3nWXy2m0tputQObl8oSkWlHQAIGUcvUbbSLYllmgHOvVE0vJRrKKNeDQV46c0TnvR7KYPQI791n+mH8R8hHf5KSrVlgHbTDmhCdcCZmnA9PEaFqFXFfkTxf8AtMIW2iYdcNKt2KWY+tfo862h1WktDQhZ/wCpjPZtlC/9CnNvq/WPrLKrqHZ3iVv0PIgcvP8AxBbFZaQB2rCTv86uXyTnvR7KYPQI791n+mH8R8hHfBytlKaSqXbUQWK2QmnrmNg/R9pFlAsh+zRCfyphb8y6t95W+tZqYBINDxxsiTcp67Z4KxziBMLdWh+zplrBKq8ld6HJqacKiTtU10IHIIzMqiiB/keVwUQ/IvbYoO1XThp4jE570eymD0CO/dZ/ph/EfIR3wpkOKDKjaLddBPs8jE7lNGx5RJCswsbZz2jiEOSUyhOx1psD7vJSLShsiSJ2swgaPjyeRM1NWpXJ3rek5+XXH1VkNptT6NG14DXt9ZULmJl1TzyzVS1mJz3o9lMHoEd+6z/TDsx8hHfGbk2aoHCeVoQn2mEzmUHkvzvorWKmv3E98LYlKyMkdFEnbr9p7oQy5NvuNI4LanCUj4QMm5e/uJZQsCYWLWjkXyjnhLDUlLGVIqE2AQeeHcnZKOx5RO0U8nhL9nIPLOe9Hspg9Ajv3XKHTjsxnpSRfmGsykW20VFdMLyexkR9a7VWnVtn7MHf0ccKmJqQnn3lb61oMXTN4Ri6ZvCMXTN4RjYSWcpplaUzQCqU5IumbwjF0zeGYumbwzE03OS7ks4qYtBLiaaLIg9Ajv3Wcbn5rMLW7aSLCjUU5hF5DCXqi8hhL1ReQwl6ovIYS9UXkMJeqLxGEvVF4/sr1ReP7S9UXkMJeqLyGEvVF5DCXqgzMk9n2c0lNqhGn4+ab34Rf//EACoQAAIBAgQFBAMBAQAAAAAAAAERACExQVFh8DBxocHxECBA0XCBkbHh/9oACAEBAAE/Ifw+RscgBkmW2BFT6TfPab57TfPaBTIzRDpCCRBCIw+G14UF2gtSgfPOKMuBIYQ0/wBzd/ubv9zd/uBOSVRUMo8qwqIhRQWPNIJfIfDIodTJgdTEpQU3yQgsaw+orwUZBiFAJuRFGwwopgfABwQR+MdDN+d5tzvN6d5sbvNrd5vbvN7d5szv6ON+d5tzvDkftULqL9cQBwFsKIu+q2conynlEeUR5xHkEeQR5BHnEeUR5RBdyTXKNOKwFwG2WS5ur6ikLgYhQggnw8kDNQs2444fCSgZJygz6SYBVuGxyhziek8vrtb+cYFgDPlBW6plzdX0WcA6wYtBKXsDEZYHX+wRzNGMMWSUVpeFLh6oAI/5/wBcFHyyf+IDSJsf6vsRw4XQCSYtLDrxwWF/lNqyy5urAEnCdZlYIoZiuEXyYKnrczTQwlUW7IHqtEKGANXQq8t3LiVSbcvJG5uGqafc6CwA6ysWxZj1OJ0FYUmpUgJZ59CxxgWF3lNuyy5urAgsQjUsTY6wAkAAycBA8wrTYqsQ1rpjBUaAgHNCykFKGxyL9YA4umR9KtoYRaYHDwcSd5M1GxJbMThK3/wCd5cYFhc5QnvqJc3Vh3RC3WZBmLTBtHJh7MTHViktOw0dYukRVzZEUJSDUgBYj7GbwAFoh+91+cLyNJ5BFEvRqdLfABYUnym8ZJflfCFQcCUpkrAKMVQ8zeXfaiPLQaQeoEEB0WdoQaW9gEUR76SIyi+h42EFMPIoSHU9yePHjh2S+gjIsPs6ePHtVnaU2EAPEJoXhPtyUs+0yUJf4g//2gAMAwEAAgADAAAAEPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPLCACPPPPPPPPNGMCAONPPPPPLIHHPLBFPPPPPOIOMPENNPPPPPPCJKEJPFPPPPPONPHJIDHPPPPPPLPPDPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPP/xAAUEQEAAAAAAAAAAAAAAAAAAABw/9oACAEDAQE/ECn/xAAUEQEAAAAAAAAAAAAAAAAAAABw/9oACAECAQE/ECn/xAAoEAEBAAIBAgUDBQEAAAAAAAABEQAhMUFREDBhcfAgQLFwgZHB8aH/2gAIAQEAAT8Q/R8OUHCDAA5XDTVVgdynX0MmTJ0rFsJyqanvjkERREfsxQ9D1LDwXXAAcsQIRYMDsFgsoWciH+wz/sM/7DIJ2Cgw0SgYZocOPOcUgHSK625q/YHJkDH7dbiGicCLdYZMwZb9EGx5DBPEQTL17uCg0dc1sMmimkd61fsGdzRkiSE5mB+C9YPX+hn569fw/Lvil+j4N3o5VctFFdeYsztLIZANWew08PVevi9ei/Q0aNmp9Xxr16KVYkA2qPRJ05z4/v5i+emON+hNsvkSQwV0beXRy5sMfegUIgKmljKg3MU4BqKZZgA2q6mSSAkG2qADe/v5zAWloppzcrRFQIFyn8P38wFG9/yYEfjW0U+Vj3RpfR12WG8Xw3UOjTOU36yEMIntUVLqQsE1Cg0HTcbJvK7diCUUKaZC0Jy9Yj3iH99Zo3u3E7dHpLBm8FDjtxLo/cOwgtXnUzv+r+TFfBrbcvqGorqBQIERVcJZsRM1JBHQSuAblEZuJ93gOANBohlaCWSHMeuMpLpTHri8sEoxK4RPzJI2KJeGSbY6N4/vmp1wCGgVVqrg/SYFXr1gssvQFJ1ALy0SsjkrCjPCn8f38wp7n8mK+F20YUoxyVKAgUpXHLKgFV7Y/Zba4DU1t8xQhwEWkf5HEc09YemVVkaCvV/bVXU2GahKbBHgNd7J2KyLNn9JoWnIrvmRVPTCP6HoBoEAAADwp/H9/MOe4/J4jzbHt9e30Gs3JOhmsxgxDdbyhVS7JmXxS7HfcBzE2i5c4aAvIxDpDWBAhHoGzGxrRHQG4DK9WTRIbdNqvNwYEZmq0W+aVCbCpa+NP4/v5h4DuCLOXG+aAlKfzht47VTwy3RQaAhir2rfOg1A6AA4AwO35HpjSvwfTPhH9Yg4EwHyDke6dq63j0fgemfOv6z51/WMVh8cxHkoX0c+P7+YUXtkOOvcRRDYkUcR+g58+fGw5wmz68XyA50fE58+PJQ+xmApuTzNpLnYf9yh9Axz1T98vT5fxnpv757L9IP/2Q\u003d\u003d"
  },
  "description": {
    "text": "This server-side tag template, developed by Métricas Boss, allows the direct submission of conversion leads to RD Station using an API Key. It simplifies the integration of custom systems and forms with RD Station Marketing, ensuring that conversion data is recorded securely and efficiently.",
    "translations": [
      {
        "locale": "br",
        "text": "Este modelo de tag server-side, desenvolvido pela Métricas Boss, permite o envio de leads de conversão diretamente para o RD Station utilizando uma API Key. Ele facilita a integração de sistemas e formulários personalizados com o RD Station Marketing, garantindo que os dados de conversão sejam registrados de forma segura e eficiente."
      }
    ]
  },
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "apiKey",
    "displayName": {
      "text": "API Key",
      "translations": [
        {
          "locale": "br",
          "text": "API Key"
        }
      ]
    },
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "conversionIdentifier",
    "displayName": {
      "text": "Conversion Identifier",
      "translations": [
        {
          "locale": "br",
          "text": "Identificador de conversão"
        }
      ]
    },
    "simpleValueType": true
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "fields",
    "displayName": {
      "text": "Fields",
      "translations": [
        {
          "locale": "br",
          "text": "Campos"
        }
      ]
    },
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": {
          "text": "Field Name",
          "translations": [
            {
              "locale": "br",
              "text": "Campo"
            }
          ]
        },
        "name": "fieldName",
        "type": "TEXT"
      },
      {
        "defaultValue": "",
        "displayName": {
          "text": "Field Value",
          "translations": [
            {
              "locale": "br",
              "text": "Valor"
            }
          ]
        },
        "name": "fieldValue",
        "type": "TEXT"
      }
    ],
    "help": {
      "text": "Fill in the fields below based on the parameters available in RD Station’s official documentation at https://developers.rdstation.com/reference/conversao. This server-side tag template was created to send conversion events using an API Key, with the default parameters event_type as CONVERSION and event_family as CDP. You can include additional fields such as email, name, phone number, and others as outlined in the documentation. If you wish to send custom fields, please ensure those fields are already created in your RD Station account and that they start with the prefix \"cf_\". For example, cf_salesperson_id. Any fields not existing in your account will be ignored.",
      "translations": [
        {
          "locale": "br",
          "text": "Preencha os campos abaixo com base nos parâmetros disponíveis na documentação oficial da RD Station em https://developers.rdstation.com/reference/conversao. Este modelo de tag server-side foi criado para enviar eventos de conversão utilizando uma API Key, com os parâmetros padrão event_type como CONVERSION e event_family como CDP. Você pode incluir campos adicionais como email, nome, telefone, entre outros, conforme a documentação. Caso deseje enviar campos personalizados, lembre-se de que eles precisam estar previamente criados na sua conta da RD Station e devem obrigatoriamente começar com o prefixo \"cf_\". Por exemplo, cf_id_vendedor. Campos que não existirem na plataforma serão ignorados."
        }
      ]
    }
  },
  {
    "type": "CHECKBOX",
    "name": "enableLog",
    "checkboxText": {
      "text": "Enable Logs",
      "translations": [
        {
          "locale": "br",
          "text": "Habilitar registros"
        }
      ]
    },
    "simpleValueType": true
  }
]


___SANDBOXED_JS_FOR_SERVER___

const sendHttpRequest    = require('sendHttpRequest');
const logToConsole       = require('logToConsole');
const JSON               = require('JSON');
const encodeUriComponent = require('encodeUriComponent');
const getAllEventData    = require('getAllEventData');

function log(message){
  if (data.enableLog){
     logToConsole(message);
  } 
}

function main() {
  const apiKey = data.apiKey;
  const convId = data.conversionIdentifier;
  if (!apiKey) {
    log('Erro: API Key não configurada');
    return data.gtmOnFailure();
  }
  if (!convId) {
    log('Erro: conversionIdentifier não configurado');
    return data.gtmOnFailure();
  }

  const eventData = getAllEventData();

  var payload = {
    event_type:   "CONVERSION",
    event_family: "CDP",
    payload: {
      conversion_identifier: convId,
    }
  };

  if (data.fields) {
    for (var i = 0; i < data.fields.length; i++) {
      var entry = data.fields[i];
      var name  = entry.fieldName;
      var value = entry.fieldValue;
      if (typeof name === 'string') {
        payload.payload[name] = value;
      }
    }
  }
  
  var url = 'https://api.rd.services/platform/conversions?api_key=' + encodeUriComponent(apiKey);
  log('Enviando para RD Station:', JSON.stringify(payload));
  sendHttpRequest(
    url,
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    },
    JSON.stringify(payload)
  ).then(function(res) {
      log('RD Station respondeu:', res.statusCode, res.body);
      if (res.statusCode >= 200 && res.statusCode < 300) {
        data.gtmOnSuccess();
      } else {
        data.gtmOnFailure();
      }
    }
  ).catch(function(err) {
      log('Erro HTTP RD Station:', err.reason);
      data.gtmOnFailure();
    }
  );
}

main();


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://api.rd.services/"
              }
            ]
          }
        },
        {
          "key": "allowGoogleDomains",
          "value": {
            "type": 8,
            "boolean": true
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []
setup: ''


___NOTES___

Created on 03/06/2025, 16:08:09


